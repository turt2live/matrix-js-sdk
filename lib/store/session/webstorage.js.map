{"version":3,"sources":["../../../src/store/session/webstorage.js"],"names":["utils","require","DEBUG","E2E_PREFIX","WebStorageSessionStore","webStore","store","isFunction","getItem","setItem","removeItem","key","length","Error","prototype","storeEndToEndAccount","account","KEY_END_TO_END_ACCOUNT","getEndToEndAccount","storeEndToEndDevicesForUser","userId","devices","setJsonItem","keyEndToEndDevicesForUser","getEndToEndDevicesForUser","getJsonItem","storeEndToEndDeviceTrackingStatus","statusMap","KEY_END_TO_END_DEVICE_LIST_TRACKING_STATUS","getEndToEndDeviceTrackingStatus","storeEndToEndDeviceSyncToken","token","KEY_END_TO_END_DEVICE_SYNC_TOKEN","getEndToEndDeviceSyncToken","storeEndToEndSession","deviceKey","sessionId","session","sessions","getEndToEndSessions","keyEndToEndSessions","getAllEndToEndInboundGroupSessionKeys","prefix","result","i","startsWith","push","senderKey","substr","getEndToEndInboundGroupSession","keyEndToEndInboundGroupSession","storeEndToEndInboundGroupSession","pickledSession","storeEndToEndRoom","roomId","roomInfo","keyEndToEndRoom","getEndToEndRoom","JSON","parse","e","debuglog","stack","val","log","arguments","module","exports"],"mappings":"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","file":"webstorage.js","sourcesContent":["/*\r\nCopyright 2015, 2016 OpenMarket Ltd\r\n\r\nLicensed under the Apache License, Version 2.0 (the \"License\");\r\nyou may not use this file except in compliance with the License.\r\nYou may obtain a copy of the License at\r\n\r\n    http://www.apache.org/licenses/LICENSE-2.0\r\n\r\nUnless required by applicable law or agreed to in writing, software\r\ndistributed under the License is distributed on an \"AS IS\" BASIS,\r\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\nSee the License for the specific language governing permissions and\r\nlimitations under the License.\r\n*/\r\n\"use strict\";\r\n\r\n/**\r\n * @module store/session/webstorage\r\n */\r\n\r\nconst utils = require(\"../../utils\");\r\n\r\nconst DEBUG = false;  // set true to enable console logging.\r\nconst E2E_PREFIX = \"session.e2e.\";\r\n\r\n/**\r\n * Construct a web storage session store, capable of storing account keys,\r\n * session keys and access tokens.\r\n * @constructor\r\n * @param {WebStorage} webStore A web storage implementation, e.g.\r\n * 'window.localStorage' or 'window.sessionStorage' or a custom implementation.\r\n * @throws if the supplied 'store' does not meet the Storage interface of the\r\n * WebStorage API.\r\n */\r\nfunction WebStorageSessionStore(webStore) {\r\n    this.store = webStore;\r\n    if (!utils.isFunction(webStore.getItem) ||\r\n        !utils.isFunction(webStore.setItem) ||\r\n        !utils.isFunction(webStore.removeItem) ||\r\n        !utils.isFunction(webStore.key) ||\r\n        typeof(webStore.length) !== 'number'\r\n       ) {\r\n        throw new Error(\r\n            \"Supplied webStore does not meet the WebStorage API interface\",\r\n        );\r\n    }\r\n}\r\n\r\nWebStorageSessionStore.prototype = {\r\n\r\n    /**\r\n     * Store the end to end account for the logged-in user.\r\n     * @param {string} account Base64 encoded account.\r\n     */\r\n    storeEndToEndAccount: function(account) {\r\n        this.store.setItem(KEY_END_TO_END_ACCOUNT, account);\r\n    },\r\n\r\n    /**\r\n     * Load the end to end account for the logged-in user.\r\n     * @return {?string} Base64 encoded account.\r\n     */\r\n    getEndToEndAccount: function() {\r\n        return this.store.getItem(KEY_END_TO_END_ACCOUNT);\r\n    },\r\n\r\n    /**\r\n     * Stores the known devices for a user.\r\n     * @param {string} userId The user's ID.\r\n     * @param {object} devices A map from device ID to keys for the device.\r\n     */\r\n    storeEndToEndDevicesForUser: function(userId, devices) {\r\n        setJsonItem(this.store, keyEndToEndDevicesForUser(userId), devices);\r\n    },\r\n\r\n    /**\r\n     * Retrieves the known devices for a user.\r\n     * @param {string} userId The user's ID.\r\n     * @return {object} A map from device ID to keys for the device.\r\n     */\r\n    getEndToEndDevicesForUser: function(userId) {\r\n        return getJsonItem(this.store, keyEndToEndDevicesForUser(userId));\r\n    },\r\n\r\n    storeEndToEndDeviceTrackingStatus: function(statusMap) {\r\n        setJsonItem(this.store, KEY_END_TO_END_DEVICE_LIST_TRACKING_STATUS, statusMap);\r\n    },\r\n\r\n    getEndToEndDeviceTrackingStatus: function() {\r\n        return getJsonItem(this.store, KEY_END_TO_END_DEVICE_LIST_TRACKING_STATUS);\r\n    },\r\n\r\n    /**\r\n     * Store the sync token corresponding to the device list.\r\n     *\r\n     * This is used when starting the client, to get a list of the users who\r\n     * have changed their device list since the list time we were running.\r\n     *\r\n     * @param {String?} token\r\n     */\r\n    storeEndToEndDeviceSyncToken: function(token) {\r\n        setJsonItem(this.store, KEY_END_TO_END_DEVICE_SYNC_TOKEN, token);\r\n    },\r\n\r\n    /**\r\n     * Get the sync token corresponding to the device list.\r\n     *\r\n     * @return {String?} token\r\n     */\r\n    getEndToEndDeviceSyncToken: function() {\r\n        return getJsonItem(this.store, KEY_END_TO_END_DEVICE_SYNC_TOKEN);\r\n    },\r\n\r\n    /**\r\n     * Store a session between the logged-in user and another device\r\n     * @param {string} deviceKey The public key of the other device.\r\n     * @param {string} sessionId The ID for this end-to-end session.\r\n     * @param {string} session Base64 encoded end-to-end session.\r\n     */\r\n    storeEndToEndSession: function(deviceKey, sessionId, session) {\r\n        const sessions = this.getEndToEndSessions(deviceKey) || {};\r\n        sessions[sessionId] = session;\r\n        setJsonItem(\r\n            this.store, keyEndToEndSessions(deviceKey), sessions,\r\n        );\r\n    },\r\n\r\n    /**\r\n     * Retrieve the end-to-end sessions between the logged-in user and another\r\n     * device.\r\n     * @param {string} deviceKey The public key of the other device.\r\n     * @return {object} A map from sessionId to Base64 end-to-end session.\r\n     */\r\n    getEndToEndSessions: function(deviceKey) {\r\n        return getJsonItem(this.store, keyEndToEndSessions(deviceKey));\r\n    },\r\n\r\n    /**\r\n     * Retrieve a list of all known inbound group sessions\r\n     *\r\n     * @return {{senderKey: string, sessionId: string}}\r\n     */\r\n    getAllEndToEndInboundGroupSessionKeys: function() {\r\n        const prefix = E2E_PREFIX + 'inboundgroupsessions/';\r\n        const result = [];\r\n        for (let i = 0; i < this.store.length; i++) {\r\n            const key = this.store.key(i);\r\n            if (!key.startsWith(prefix)) {\r\n                continue;\r\n            }\r\n            // we can't use split, as the components we are trying to split out\r\n            // might themselves contain '/' characters. We rely on the\r\n            // senderKey being a (32-byte) curve25519 key, base64-encoded\r\n            // (hence 43 characters long).\r\n\r\n            result.push({\r\n                senderKey: key.substr(prefix.length, 43),\r\n                sessionId: key.substr(prefix.length + 44),\r\n            });\r\n        }\r\n        return result;\r\n    },\r\n\r\n    getEndToEndInboundGroupSession: function(senderKey, sessionId) {\r\n        const key = keyEndToEndInboundGroupSession(senderKey, sessionId);\r\n        return this.store.getItem(key);\r\n    },\r\n\r\n    storeEndToEndInboundGroupSession: function(senderKey, sessionId, pickledSession) {\r\n        const key = keyEndToEndInboundGroupSession(senderKey, sessionId);\r\n        return this.store.setItem(key, pickledSession);\r\n    },\r\n\r\n    /**\r\n     * Store the end-to-end state for a room.\r\n     * @param {string} roomId The room's ID.\r\n     * @param {object} roomInfo The end-to-end info for the room.\r\n     */\r\n    storeEndToEndRoom: function(roomId, roomInfo) {\r\n        setJsonItem(this.store, keyEndToEndRoom(roomId), roomInfo);\r\n    },\r\n\r\n    /**\r\n     * Get the end-to-end state for a room\r\n     * @param {string} roomId The room's ID.\r\n     * @return {object} The end-to-end info for the room.\r\n     */\r\n    getEndToEndRoom: function(roomId) {\r\n        return getJsonItem(this.store, keyEndToEndRoom(roomId));\r\n    },\r\n};\r\n\r\nconst KEY_END_TO_END_ACCOUNT = E2E_PREFIX + \"account\";\r\nconst KEY_END_TO_END_DEVICE_SYNC_TOKEN = E2E_PREFIX + \"device_sync_token\";\r\nconst KEY_END_TO_END_DEVICE_LIST_TRACKING_STATUS = E2E_PREFIX + \"device_tracking\";\r\n\r\nfunction keyEndToEndDevicesForUser(userId) {\r\n    return E2E_PREFIX + \"devices/\" + userId;\r\n}\r\n\r\nfunction keyEndToEndSessions(deviceKey) {\r\n    return E2E_PREFIX + \"sessions/\" + deviceKey;\r\n}\r\n\r\nfunction keyEndToEndInboundGroupSession(senderKey, sessionId) {\r\n    return E2E_PREFIX + \"inboundgroupsessions/\" + senderKey + \"/\" + sessionId;\r\n}\r\n\r\nfunction keyEndToEndRoom(roomId) {\r\n    return E2E_PREFIX + \"rooms/\" + roomId;\r\n}\r\n\r\nfunction getJsonItem(store, key) {\r\n    try {\r\n        // if the key is absent, store.getItem() returns null, and\r\n        // JSON.parse(null) === null, so this returns null.\r\n        return JSON.parse(store.getItem(key));\r\n    } catch (e) {\r\n        debuglog(\"Failed to get key %s: %s\", key, e);\r\n        debuglog(e.stack);\r\n    }\r\n    return null;\r\n}\r\n\r\nfunction setJsonItem(store, key, val) {\r\n    store.setItem(key, JSON.stringify(val));\r\n}\r\n\r\nfunction debuglog() {\r\n    if (DEBUG) {\r\n        console.log(...arguments);\r\n    }\r\n}\r\n\r\n/** */\r\nmodule.exports = WebStorageSessionStore;\r\n"]}